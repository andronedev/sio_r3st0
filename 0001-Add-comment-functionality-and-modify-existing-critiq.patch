From fb085d14cb64fe63f34a87b070c744b36f0dbaac Mon Sep 17 00:00:00 2001
From: andronedev <andronedev@gmail.com>
Date: Fri, 9 Feb 2024 10:31:59 +0100
Subject: [PATCH] Add comment functionality and modify existing critique
 functionality

---
 controleur/commenter.php           | 32 ++++++++++++++
 controleur/controleurPrincipal.php |  2 +
 controleur/detailResto.php         |  3 +-
 controleur/supprimerCritique.php   | 20 +++++++++
 modele/bd.critiquer.inc.php        | 67 ++++++++++++++++++++++++++++++
 vue/vueDetailResto.php             | 46 +++++++++++++++++++-
 6 files changed, 167 insertions(+), 3 deletions(-)
 create mode 100755 controleur/commenter.php
 create mode 100755 controleur/supprimerCritique.php

diff --git a/controleur/commenter.php b/controleur/commenter.php
new file mode 100755
index 0000000..c0cccb0
--- /dev/null
+++ b/controleur/commenter.php
@@ -0,0 +1,32 @@
+<?php
+
+if ($_SERVER["SCRIPT_FILENAME"] == __FILE__) {
+    $racine = "..";
+}
+include_once "$racine/modele/bd.resto.inc.php";
+include_once "$racine/modele/bd.photo.inc.php";
+include_once "$racine/modele/bd.critiquer.inc.php";
+include_once "$racine/modele/authentification.inc.php";
+
+if ($_SERVER["REQUEST_METHOD"] == "POST") {
+    $commentaire = $_POST["commentaire"];
+    $idR = $_POST["idR"];
+    $note = $_POST["note"];
+    $do = $_POST["do"];
+    $note = intval($note);
+    var_dump($note);
+    //exit;
+
+    if ($do == "ajouter") {
+        addCritiquer($idR, getMailULoggedOn(), $note, $commentaire);
+        header("Location: $?action=detail&idR=$idR");
+        exit;
+    } else if ($do == "modifier") {
+        editCritiquer($idR, getMailULoggedOn(), $note, $commentaire);
+        header("Location: $?action=detail&idR=$idR");
+        exit;
+    }
+    exit;
+}
+
+
diff --git a/controleur/controleurPrincipal.php b/controleur/controleurPrincipal.php
index 545c65b..ce6b6f7 100755
--- a/controleur/controleurPrincipal.php
+++ b/controleur/controleurPrincipal.php
@@ -12,6 +12,8 @@ function controleurPrincipal($action) {
     $lesActions["cgu"] = "cgu.php";
     $lesActions["aimer"] = "aimer.php";
     $lesActions["inscription"] = "inscription.php";
+    $lesActions["commenter"] = "commenter.php";
+    $lesActions["supprimerCritique"] = "supprimerCritique.php";
 
     if (array_key_exists($action, $lesActions)) {
         return $lesActions[$action];
diff --git a/controleur/detailResto.php b/controleur/detailResto.php
index 03b7a7c..6061a65 100755
--- a/controleur/detailResto.php
+++ b/controleur/detailResto.php
@@ -30,8 +30,7 @@ $noteMoy = round(getNoteMoyenneByIdR($idR), 0);
 $mailU = getMailULoggedOn();
 $aimer = getAimerById($mailU, $idR);
 $critiques = getCritiquerByIdR($idR);
-
-
+$maCritique = maCritique($idR, getMailULoggedOn());
 // appel du script de vue qui permet de gerer l'affichage des donnees
 $titre = "detail d'un restaurant";
 include "$racine/vue/entete.html.php";
diff --git a/controleur/supprimerCritique.php b/controleur/supprimerCritique.php
new file mode 100755
index 0000000..760dde8
--- /dev/null
+++ b/controleur/supprimerCritique.php
@@ -0,0 +1,20 @@
+<?php
+
+if ($_SERVER["SCRIPT_FILENAME"] == __FILE__) {
+    $racine = "..";
+}
+include_once "$racine/modele/bd.resto.inc.php";
+include_once "$racine/modele/bd.photo.inc.php";
+include_once "$racine/modele/bd.critiquer.inc.php";
+include_once "$racine/modele/authentification.inc.php";
+
+
+$idR = $_GET["idR"];
+$mailU = getMailULoggedOn();
+
+deleteCritiquer($idR, $mailU);
+header("Location: ?action=detail&idR=$idR");
+exit;
+
+
+
diff --git a/modele/bd.critiquer.inc.php b/modele/bd.critiquer.inc.php
index c4cfab2..009b7d8 100755
--- a/modele/bd.critiquer.inc.php
+++ b/modele/bd.critiquer.inc.php
@@ -24,6 +24,73 @@ function getCritiquerByIdR($idR) {
     return $resultat;
 }
 
+function addCritiquer($idR, $mailU, $note, $commentaire) {
+    try {
+        $cnx = connexionPDO();
+        $req = $cnx->prepare("insert into critiquer (idR, mailU, note, commentaire) values (:idR, :mailU, :note, :commentaire)");
+        $req->bindValue(':idR', $idR, PDO::PARAM_INT);
+        $req->bindValue(':mailU', $mailU, PDO::PARAM_STR);
+        $req->bindValue(':note', $note, PDO::PARAM_INT);
+        $req->bindValue(':commentaire', $commentaire, PDO::PARAM_STR);
+        
+        $req->execute();
+    } catch (PDOException $e) {
+        print "Erreur !: " . $e->getMessage();
+        die();
+    }
+}
+
+function editCritiquer($idR, $mailU, $note, $commentaire) {
+    try {
+        $cnx = connexionPDO();
+        $req = $cnx->prepare("update critiquer set note=:note, commentaire=:commentaire where idR=:idR and mailU=:mailU");
+        $req->bindValue(':idR', $idR, PDO::PARAM_INT);
+        $req->bindValue(':mailU', $mailU, PDO::PARAM_STR);
+        $req->bindValue(':note', $note, PDO::PARAM_INT);
+        $req->bindValue(':commentaire', $commentaire, PDO::PARAM_STR);
+        
+        $req->execute();
+    } catch (PDOException $e) {
+        print "Erreur !: " . $e->getMessage();
+        die();
+    }
+}
+
+function maCritique($idR, $mailU) {
+    try {
+        $cnx = connexionPDO();
+        $req = $cnx->prepare("select * from critiquer where idR=:idR and mailU=:mailU");
+        $req->bindValue(':idR', $idR, PDO::PARAM_INT);
+        $req->bindValue(':mailU', $mailU, PDO::PARAM_STR);
+        
+        $req->execute();
+
+        $resultat = $req->fetch(PDO::FETCH_ASSOC);
+    } catch (PDOException $e) {
+        print "Erreur !: " . $e->getMessage();
+        die();
+    }
+    if ($req->rowCount() > 0) {
+        return $resultat;
+    } else {
+        return false;
+    }
+}
+
+function deleteCritiquer($idR, $mailU) {
+    try {
+        $cnx = connexionPDO();
+        $req = $cnx->prepare("delete from critiquer where idR=:idR and mailU=:mailU");
+        $req->bindValue(':idR', $idR, PDO::PARAM_INT);
+        $req->bindValue(':mailU', $mailU, PDO::PARAM_STR);
+        
+        $req->execute();
+    } catch (PDOException $e) {
+        print "Erreur !: " . $e->getMessage();
+        die();
+    }
+}
+
 function getNoteMoyenneByIdR($idR) {
 
     try {
diff --git a/vue/vueDetailResto.php b/vue/vueDetailResto.php
index 1064073..a29eb59 100755
--- a/vue/vueDetailResto.php
+++ b/vue/vueDetailResto.php
@@ -132,4 +132,48 @@
     </li>
     <?php } ?>
 
-</ul>
\ No newline at end of file
+</ul>
+
+<h2>Ajouter une critique</h2>
+
+
+<?php if ($maCritique == false) { ?>
+<form action="?action=commenter" method="POST">
+    <label for="commentaire">Commentaire :</label>
+    <input type="text" name="commentaire" id="commentaire" required>
+
+    <div> 
+        <label>Note :</label>
+        <input type="radio" name="note" value="1" required> 1
+        <input type="radio" name="note" value="2" required> 2
+        <input type="radio" name="note" value="3" required> 3
+        <input type="radio" name="note" value="4" required> 4
+        <input type="radio" name="note" value="5" required> 5
+    </div>
+    <br>
+    <input type="hidden" name="do" value="ajouter">
+    <input type="hidden" name="idR" value="<?= $unResto['idR']; ?>">
+    <input type="submit" value="Ajouter" style="width: 100px; height: 30px;">
+</form>
+
+<?php } else { ?>
+<p>Vous avez déjà commenté ce restaurant</p>
+<small>Modifier votre commentaire</small>
+<form action="?action=commenter" method="POST">
+    <label for="commentaire">Commentaire :</label>
+    <input type="text" name="commentaire" id="commentaire" required value="<?= $maCritique['commentaire']; ?>">
+
+    <div> 
+        <label>Note :</label>
+        <input type="radio" name="note" value="1" required <?php if (!isset($maCritique['note']) || $maCritique['note'] == '1') echo 'checked'; ?>> 1
+        <input type="radio" name="note" value="2" required <?php if (isset($maCritique['note']) && $maCritique['note'] == '2') echo 'checked'; ?>> 2
+        <input type="radio" name="note" value="3" required <?php if (isset($maCritique['note']) && $maCritique['note'] == '3') echo 'checked'; ?>> 3
+        <input type="radio" name="note" value="4" required <?php if (isset($maCritique['note']) && $maCritique['note'] == '4') echo 'checked'; ?>> 4
+        <input type="radio" name="note" value="5" required <?php if (isset($maCritique['note']) && $maCritique['note'] == '5') echo 'checked'; ?>> 5
+    </div>
+    <br>
+    <input type="hidden" name="do" value="modifier">
+    <input type="hidden" name="idR" value="<?= $unResto['idR']; ?>">
+    <input type="submit" value="Modifier" style="width: 100px; height: 30px;">
+</form>
+<?php } ?>
\ No newline at end of file
-- 
2.34.1

